<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منسوبي المدرسة - مدرسة عمرو بن العاص</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
    <style>
        /* جميع التنسيقات السابقة تبقى كما هي */
        :root {
            --primary: #2c5aa0;
            --primary-dark: #1e3d72;
            --primary-light: #4a7bc8;
            --secondary: #4caf50;
            --secondary-dark: #3d8b40;
            --accent: #ff9800;
            --accent-dark: #e68900;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --gray-light: #e9ecef;
            --border-radius: 8px;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 5px 15px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
            direction: rtl;
        }

        .staff-layout {
            display: flex;
            min-height: 100vh;
        }

        /* الشريط الجانبي للتصنيفات */
        .sidebar {
            width: 280px;
            background: white;
            box-shadow: var(--shadow);
            transition: var(--transition);
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 25px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            text-align: center;
        }

        .sidebar-nav {
            list-style: none;
            padding: 20px 0;
        }

        .nav-item {
            margin-bottom: 5px;
        }

        .nav-item a {
            display: flex;
            align-items: center;
            padding: 12px 25px;
            color: var(--dark);
            text-decoration: none;
            transition: var(--transition);
            border-right: 3px solid transparent;
        }

        .nav-item a:hover,
        .nav-item.active a {
            background: var(--light);
            color: var(--primary);
            border-right-color: var(--accent);
        }

        .nav-item i {
            margin-left: 12px;
            font-size: 18px;
            width: 20px;
            text-align: center;
        }

        .nav-badge {
            background: var(--primary);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-right: auto;
            margin-left: 10px;
        }

        /* المحتوى الرئيسي */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .staff-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: var(--shadow);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-info h1 {
            font-size: 24px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-info p {
            opacity: 0.9;
            font-size: 14px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-welcome {
            font-size: 16px;
        }

        .content-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        /* أقسام المحتوى */
        .content-section {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            overflow: hidden;
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--gray-light);
            background: var(--light);
        }

        .section-header h2 {
            font-size: 18px;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-body {
            padding: 25px;
        }

        /* بطاقات التصنيفات */
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .category-card {
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius);
            overflow: hidden;
            transition: var(--transition);
        }

        .category-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .category-header {
            background: var(--light);
            padding: 15px 20px;
            border-bottom: 1px solid var(--gray-light);
            font-weight: 600;
            color: var(--primary);
        }

        .category-files {
            padding: 0;
        }

        .file-item {
            padding: 12px 20px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: var(--transition);
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-item:hover {
            background: var(--light);
        }

        .file-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .file-date {
            font-size: 12px;
            color: var(--gray);
            background: var(--gray-light);
            padding: 4px 8px;
            border-radius: 4px;
        }

        /* الأحداث */
        .calendar-events {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .event-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .event-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .event-days {
            background: var(--accent);
            color: white;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            font-weight: 600;
            font-size: 14px;
            min-width: 70px;
            text-align: center;
        }

        .event-days.expired {
            background-color: #6c757d;
        }

        /* المعلومات السريعة */
        .quick-info {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            border: 1px solid var(--gray-light);
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .info-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow);
        }

        .info-item i {
            width: 50px;
            height: 50px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .info-item h3 {
            font-size: 16px;
            margin-bottom: 5px;
            color: var(--dark);
        }

        .info-item p {
            font-size: 14px;
            color: var(--gray);
        }

        /* الجداول */
        .schedule-container {
            margin-top: 20px;
            overflow-x: auto;
        }

        .table-actions {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            min-width: 800px;
        }

        .schedule-table th,
        .schedule-table td {
            border: 1px solid var(--gray-light);
            padding: 10px;
            text-align: center;
        }

        .schedule-table th {
            background-color: var(--primary);
            color: white;
            font-weight: 600;
        }

        .schedule-table .teacher-name {
            background-color: var(--light);
            font-weight: 600;
            text-align: right;
            padding: 12px;
        }

        /* نافذة الاطلاع */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            width: 90%;
            max-width: 600px;
            box-shadow: var(--shadow-lg);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--gray-light);
        }

        .modal-header h3 {
            margin: 0;
            color: var(--primary);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--gray);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* الأزرار */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-success {
            background-color: var(--secondary);
            color: white;
        }

        .btn-success:hover {
            background-color: var(--secondary-dark);
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--gray);
            color: var(--dark);
        }

        .btn-outline:hover {
            background-color: var(--gray-light);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .badge {
            background: #ff9800;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            margin-right: 8px;
        }

        /* أنماط جدول توقيت الدوام */
        .work-schedule-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .work-schedule-table th,
        .work-schedule-table td {
            border: 1px solid var(--gray-light);
            padding: 12px;
            text-align: center;
        }

        .work-schedule-table th {
            background-color: var(--primary);
            color: white;
            font-weight: 600;
        }

        .work-schedule-table tr:nth-child(even) {
            background-color: var(--light);
        }

        .work-schedule-table tr:hover {
            background-color: #f0f5ff;
        }

        .time-type-badge {
            background: var(--accent);
            color: white;
            padding: 8px 16px;
            border-radius: var(--border-radius);
            font-weight: 600;
            margin-bottom: 20px;
            display: inline-block;
        }

        /* التجاوب */
        @media (max-width: 1024px) {
            .sidebar {
                width: 80px;
            }
            
            .sidebar-header h2,
            .nav-item span,
            .nav-badge {
                display: none;
            }
            
            .nav-item a {
                justify-content: center;
                padding: 15px;
            }
            
            .nav-item i {
                margin-left: 0;
            }
        }

        @media (max-width: 768px) {
            .staff-layout {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .sidebar-nav {
                display: flex;
                overflow-x: auto;
                padding: 15px;
            }
            
            .nav-item {
                margin-bottom: 0;
                flex: 0 0 auto;
            }
            
            .nav-item a {
                border-right: none;
                border-bottom: 3px solid transparent;
                flex-direction: column;
                padding: 10px 15px;
                font-size: 12px;
            }
            
            .nav-item.active a {
                border-right-color: transparent;
                border-bottom-color: var(--accent);
            }
            
            .nav-item i {
                margin-left: 0;
                margin-bottom: 5px;
                font-size: 16px;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .categories-grid {
                grid-template-columns: 1fr;
            }
            
            .quick-info {
                grid-template-columns: 1fr;
            }
            
            .table-actions {
                flex-direction: column;
            }
            
            .file-actions {
                flex-direction: column;
                gap: 5px;
            }

            .work-schedule-table {
                font-size: 12px;
            }
            
            .work-schedule-table th,
            .work-schedule-table td {
                padding: 8px 4px;
            }
        }
    </style>
</head>
<body>
    <!-- نافذة الاطلاع على الملفات الجديدة -->
    <div id="newFilesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>الملفات الجديدة المرسلة لك</h3>
            </div>
            <div class="modal-body">
                <p>يوجد لديك ملفات جديدة تحتاج إلى الاطلاع عليها. يرجى الاطلاع على جميع الملفات:</p>
                <div id="newFilesList" style="margin-top: 15px; max-height: 300px; overflow-y: auto;"></div>
                <div id="remainingFiles" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; text-align: center; font-weight: bold;">
                    الملفات المتبقية للمعاينة: <span id="remainingCount">0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة عرض الملف -->
    <div id="fileViewerModal" class="modal">
        <div class="modal-content" style="max-width: 90%; max-height: 90%;">
            <div class="modal-header">
                <h3 id="fileViewerTitle">عرض الملف</h3>
                <button class="close-modal" onclick="closeFileViewer()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <div id="fileViewerContent"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="downloadCurrentFile()">
                    <i class="fas fa-download"></i>
                    تحميل الملف
                </button>
                <button class="btn btn-outline" onclick="closeFileViewer()">
                    <i class="fas fa-times"></i>
                    إغلاق
                </button>
            </div>
        </div>
    </div>

    <div class="staff-layout">
        <!-- الشريط الجانبي للتصنيفات -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-folder"></i> التصنيفات</h2>
            </div>
            <ul class="sidebar-nav" id="categoriesNav">
                <!-- سيتم ملؤها بالجافاسكريبت -->
            </ul>
        </nav>

        <main class="main-content">
            <header class="staff-header">
                <div class="header-content">
                    <div class="header-info">
                        <h1>
                            <i class="fas fa-school"></i>
                            بوابة منسوبي المدرسة
                        </h1>
                        <p>مرحبًا بك في نظام إدارة المدرسة</p>
                    </div>
                    
                    <div class="header-actions">
                        <div class="user-welcome">
                            <span>مرحبًا، <strong id="staffUserName"></strong></span>
                        </div>
                        <button class="btn btn-outline" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i>
                            تسجيل الخروج
                        </button>
                    </div>
                </div>
            </header>

            <div class="content-area">
                <!-- قسم الملفات -->
                <section id="files-section" class="content-section">
                    <div class="section-header">
                        <h2>
                            <i class="fas fa-folder-open"></i>
                            الملفات المتاحة
                        </h2>
                    </div>
                    <div class="section-body">
                        <div class="categories-grid" id="fileCategories">
                            <!-- سيتم ملؤها بالبيانات -->
                        </div>
                    </div>
                </section>

                <!-- قسم التقويم الدراسي -->
                <section id="calendar-section" class="content-section">
                    <div class="section-header">
                        <h2>
                            <i class="fas fa-calendar-alt"></i>
                            التقويم الدراسي
                        </h2>
                    </div>
                    <div class="section-body">
                        <div class="calendar-events" id="calendarList">
                            <!-- سيتم ملؤها بالبيانات -->
                        </div>
                    </div>
                </section>

                <!-- قسم الجدول الدراسي -->
                <section id="schedule-section" class="content-section">
                    <div class="section-header">
                        <h2>
                            <i class="fas fa-table"></i>
                            الجدول الدراسي
                        </h2>
                    </div>
                    <div class="section-body">
                        <div class="table-actions">
                            <button class="btn btn-outline" onclick="printSchedule()">
                                <i class="fas fa-print"></i>
                                طباعة الجدول
                            </button>
                        </div>
                        <div class="schedule-container">
                            <div id="teacherSchedule"></div>
                        </div>
                    </div>
                </section>

                <!-- قسم الجدول العام للمعلمين -->
                <section id="teachers-schedule-section" class="content-section">
                    <div class="section-header">
                        <h2>
                            <i class="fas fa-chalkboard-teacher"></i>
                            الجدول العام للمعلمين
                        </h2>
                    </div>
                    <div class="section-body">
                        <div class="table-actions">
                            <button class="btn btn-outline" onclick="printTeachersSchedule()">
                                <i class="fas fa-print"></i>
                                طباعة الجدول
                            </button>
                        </div>
                        <div class="schedule-container">
                            <div id="teachersSchedule"></div>
                        </div>
                    </div>
                </section>

                <!-- قسم المعلومات السريعة -->
                <section id="info-section" class="content-section">
                    <div class="section-header">
                        <h2>
                            <i class="fas fa-info-circle"></i>
                            معلومات سريعة
                        </h2>
                    </div>
                    <div class="section-body">
                        <!-- هذا هو العنصر الذي سيعرض جدول التوقيت -->
                        <div id="workScheduleInfo"></div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        // البيانات والمتغيرات
        let newFiles = [];
        let viewedFiles = JSON.parse(localStorage.getItem("viewedFiles")) || [];
        let fileReadStatus = {};
        let currentViewingFile = null;

        // تسجيل الخروج
        function logout() {
            localStorage.removeItem("role");
            localStorage.removeItem("currentStaff");
            window.location.href = "index.html";
        }

        // تحميل الملفات الموجهة للموظف
        async function loadUserFiles() {
            try {
                const files = await Database.getFiles();
                const currentStaff = JSON.parse(localStorage.getItem("currentStaff"));
                
                if (!currentStaff) return [];
                
                // تصفية الملفات الموجهة للموظف الحالي
                const userFiles = files.filter(file => {
                    // التحقق إذا كان الموظف مستهدف بالاسم
                    if (file.target_staff && file.target_staff.includes(currentStaff.id)) {
                        return true;
                    }
                    
                    // التحقق إذا كان الموظف معلم والملف موجه لمادته
                    if (currentStaff.jobs && currentStaff.jobs.includes("معلم") && 
                        file.target_subjects && file.target_subjects.some(subject => 
                            currentStaff.subjects && currentStaff.subjects.includes(subject)
                        )) {
                        return true;
                    }
                    
                    // التحقق إذا كان الملف موجه لصفوف المعلم
                    if (currentStaff.jobs && currentStaff.jobs.includes("معلم") && 
                        file.target_classes && file.target_classes.some(cls => 
                            currentStaff.classes && currentStaff.classes.includes(cls)
                        )) {
                        return true;
                    }
                    
                    return false;
                });
                
                return userFiles;
            } catch (error) {
                console.error("خطأ في جلب الملفات:", error);
                return [];
            }
        }

        // التحقق من الملفات الجديدة
        async function checkNewFiles() {
            try {
                const userFiles = await loadUserFiles();
                newFiles = userFiles.filter(file => !viewedFiles.includes(file.id));
                
                if (newFiles.length > 0) {
                    showNewFilesModal();
                } else {
                    await initializeStaffInterface();
                }
            } catch (error) {
                console.error("خطأ في التحقق من الملفات الجديدة:", error);
            }
        }

        // عرض نافذة الملفات الجديدة
        function showNewFilesModal() {
            const newFilesList = document.getElementById("newFilesList");
            const remainingCount = document.getElementById("remainingCount");
            
            newFilesList.innerHTML = newFiles.map(file => `
                <div class="file-item" id="file-${file.id}">
                    <div>
                        <strong>${file.title}</strong>
                        <div style="font-size: 12px; color: #666; margin-top: 4px;">
                            ${file.category} - ${file.date}
                        </div>
                        ${file.note ? `<div style="font-size: 12px; color: #666; margin-top: 2px;">${file.note}</div>` : ''}
                    </div>
                    <div class="file-actions">
                        <button class="btn btn-primary btn-sm" onclick="previewFileFromModal('${file.id}')">
                            <i class="fas fa-eye"></i>
                            معاينة
                        </button>
                    </div>
                </div>
            `).join('');
            
            remainingCount.textContent = newFiles.length;
            document.getElementById("newFilesModal").classList.add("active");
        }

        // تحديث عرض النافذة بعد معاينة ملف
        function updateModalDisplay() {
            const remainingCount = document.getElementById("remainingCount");
            remainingCount.textContent = newFiles.length;
            
            // إذا لم يعد هناك ملفات، أغلق النافذة وابدأ التطبيق
            if (newFiles.length === 0) {
                document.getElementById("newFilesModal").classList.remove("active");
                initializeStaffInterface();
            }
        }

        // معاينة ملف من النافذة المنبثقة
        async function previewFileFromModal(fileId) {
            try {
                const currentStaff = JSON.parse(localStorage.getItem("currentStaff"));
                const currentTime = new Date().toISOString();
                const files = await Database.getFiles();
                const file = files.find(f => f.id === fileId);
                
                if (!file) {
                    alert("الملف غير موجود");
                    return;
                }

                // إضافة الملف إلى قائمة الملفات التي تم الاطلاع عليها
                if (!viewedFiles.includes(fileId)) {
                    viewedFiles.push(fileId);
                    localStorage.setItem("viewedFiles", JSON.stringify(viewedFiles));
                }
                
                // تسجيل حالة الاطلاع في قاعدة البيانات
                await Database.updateFileReadStatus(fileId, currentStaff.id, {
                    read: true,
                    read_date: currentTime,
                    staff_name: currentStaff.name
                });
                
                // فتح محتوى الملف
                openFileContent(file);
                
                // إزالة الملف من قائمة الملفات الجديدة
                newFiles = newFiles.filter(file => file.id !== fileId);
                
                // إزالة الملف من العرض في النافذة
                const fileElement = document.getElementById(`file-${fileId}`);
                if (fileElement) {
                    fileElement.remove();
                }
                
                // تحديث العداد والعرض
                updateModalDisplay();
                
            } catch (error) {
                console.error("خطأ في معاينة الملف:", error);
            }
        }

        // فتح محتوى الملف
        async function openFileContent(file) {
            currentViewingFile = file;
            
            // عرض الملف في نافذة المعاينة
            document.getElementById('fileViewerTitle').textContent = file.title;
            const contentDiv = document.getElementById('fileViewerContent');
            
            // بناء محتوى الملف
            let content = `
                <div style="margin-bottom: 20px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                        <strong>التصنيف:</strong> ${file.category}<br>
                        <strong>التاريخ:</strong> ${file.date}<br>
                        ${file.file_name ? `<strong>اسم الملف:</strong> ${file.file_name}` : ''}
                    </div>
                    
                    ${file.note ? `
                        <div style="background: #fff3cd; padding: 15px; border-radius: 6px; border-right: 4px solid #ffc107; margin-bottom: 20px;">
                            <strong>ملاحظات:</strong> ${file.note}
                        </div>
                    ` : ''}
                </div>
            `;
            
            // محاكاة محتوى الملف بناءً على نوعه
            if (file.file_name) {
                const fileExtension = file.file_name.split('.').pop().toLowerCase();
                
                switch(fileExtension) {
                    case 'pdf':
                        content += `
                            <div style="text-align: center; padding: 20px;">
                                <i class="fas fa-file-pdf" style="font-size: 64px; color: #e74c3c;"></i>
                                <h3 style="margin: 15px 0;">ملف PDF</h3>
                                <p>هذا ملف PDF. يمكنك تحميله ومشاهدته على جهازك.</p>
                                <p><strong>${file.file_name}</strong></p>
                            </div>
                        `;
                        break;
                    case 'doc':
                    case 'docx':
                        content += `
                            <div style="text-align: center; padding: 20px;">
                                <i class="fas fa-file-word" style="font-size: 64px; color: #2b579a;"></i>
                                <h3 style="margin: 15px 0;">ملف Word</h3>
                                <p>هذا ملف Word. يمكنك تحميله وفتحه في برنامج Microsoft Word.</p>
                                <p><strong>${file.file_name}</strong></p>
                            </div>
                        `;
                        break;
                    case 'xls':
                    case 'xlsx':
                        content += `
                            <div style="text-align: center; padding: 20px;">
                                <i class="fas fa-file-excel" style="font-size: 64px; color: #217346;"></i>
                                <h3 style="margin: 15px 0;">ملف Excel</h3>
                                <p>هذا ملف Excel. يمكنك تحميله وفتحه في برنامج Microsoft Excel.</p>
                                <p><strong>${file.file_name}</strong></p>
                            </div>
                        `;
                        break;
                    case 'jpg':
                    case 'jpeg':
                    case 'png':
                    case 'gif':
                        content += `
                            <div style="text-align: center; padding: 20px;">
                                <i class="fas fa-file-image" style="font-size: 64px; color: #e67e22;"></i>
                                <h3 style="margin: 15px 0;">ملف صورة</h3>
                                <p>هذا ملف صورة. يمكنك تحميله ومشاهدته على جهازك.</p>
                                <p><strong>${file.file_name}</strong></p>
                            </div>
                        `;
                        break;
                    default:
                        content += `
                            <div style="text-align: center; padding: 20px;">
                                <i class="fas fa-file" style="font-size: 64px; color: #6c757d;"></i>
                                <h3 style="margin: 15px 0;">ملف ${fileExtension.toUpperCase()}</h3>
                                <p>هذا ملف من النوع ${fileExtension.toUpperCase()}. يمكنك تحميله وفتحه بالبرنامج المناسب.</p>
                                <p><strong>${file.file_name}</strong></p>
                            </div>
                        `;
                }
            } else {
                // ملف نصي بدون مرفق
                content += `
                    <div style="background: white; padding: 20px; border-radius: 6px; border: 1px solid #e9ecef;">
                        <h4 style="color: #2c5aa0; margin-bottom: 15px;">محتوى الملف:</h4>
                        <div style="line-height: 1.8; font-size: 16px;">
                            <p><strong>عنوان المحتوى:</strong> ${file.title}</p>
                            <p><strong>التصنيف:</strong> ${file.category}</p>
                            <p><strong>التاريخ:</strong> ${file.date}</p>
                            ${file.note ? `<p><strong>ملاحظات إضافية:</strong> ${file.note}</p>` : ''}
                            <p style="margin-top: 20px; padding: 15px; background: #e8f4fd; border-radius: 6px;">
                                هذا محتوى نصي تم إرساله من إدارة المدرسة. يمكنك التواصل مع الإدارة للحصول على أي توضيحات إضافية.
                            </p>
                        </div>
                    </div>
                `;
            }
            
            contentDiv.innerHTML = content;
            document.getElementById('fileViewerModal').classList.add('active');
        }

        // إغلاق نافذة المعاينة
        function closeFileViewer() {
            document.getElementById('fileViewerModal').classList.remove('active');
            currentViewingFile = null;
        }

        // تحميل الملف الحالي المعروض
        function downloadCurrentFile() {
            if (currentViewingFile) {
                downloadFile(currentViewingFile.id);
            }
        }

        // تحميل الملف
        async function downloadFile(fileId) {
            try {
                const currentStaff = JSON.parse(localStorage.getItem("currentStaff"));
                const currentTime = new Date().toISOString();
                const files = await Database.getFiles();
                const file = files.find(f => f.id === fileId);
                
                if (!file) {
                    alert("الملف غير موجود");
                    return;
                }

                // إضافة الملف إلى قائمة الملفات التي تم الاطلاع عليها
                if (!viewedFiles.includes(fileId)) {
                    viewedFiles.push(fileId);
                    localStorage.setItem("viewedFiles", JSON.stringify(viewedFiles));
                }
                
                // تسجيل حالة الاطلاع في قاعدة البيانات
                await Database.updateFileReadStatus(fileId, currentStaff.id, {
                    read: true,
                    read_date: currentTime,
                    staff_name: currentStaff.name,
                    downloaded: true
                });
                
                // تحديث الشريط الجانبي
                await loadCategoriesNav();
                
                // إنشاء ملف حقيقي للتحميل
                createDownloadableFile(file);
                
            } catch (error) {
                console.error("خطأ في تحميل الملف:", error);
            }
        }

        // إنشاء ملف حقيقي للتحميل
        function createDownloadableFile(file) {
            const link = document.createElement('a');
            link.style.display = 'none';
            
            let content = '';
            let mimeType = 'text/plain';
            let extension = 'txt';
            
            // تحديد نوع المحتوى بناءً على نوع الملف
            if (file.file_name) {
                const fileExt = file.file_name.split('.').pop().toLowerCase();
                
                switch(fileExt) {
                    case 'pdf':
                        mimeType = 'application/pdf';
                        extension = 'pdf';
                        content = `%PDF-1.4\n1 0 obj\n<<\n/Type /Catalog\n/Pages 2 0 R\n>>\nendobj\n2 0 obj\n<<\n/Type /Pages\n/Kids [3 0 R]\n/Count 1\n>>\nendobj\n3 0 obj\n<<\n/Type /Page\n/Parent 2 0 R\n/MediaBox [0 0 612 792]\n/Contents 4 0 R\n>>\nendobj\n4 0 obj\n<<\n/Length 44\n>>\nstream\nBT\n/F1 12 Tf\n100 700 Td\n(${file.title}) Tj\nET\nendstream\nendobj\nxref\n0 5\n0000000000 65535 f \n0000000009 00000 n \n0000000058 00000 n \n0000000115 00000 n \n0000000239 00000 n \ntrailer\n<<\n/Size 5\n/Root 1 0 R\n>>\nstartxref\n307\n%%EOF`;
                        break;
                    case 'docx':
                        mimeType = 'application/vnd.openxmlformats-officedocument.wordprocessingml.document';
                        extension = 'docx';
                        content = `محتوى ملف Word: ${file.title}\n\nالتصنيف: ${file.category}\nالتاريخ: ${file.date}\n${file.note ? `ملاحظات: ${file.note}\n` : ''}`;
                        break;
                    case 'xlsx':
                        mimeType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
                        extension = 'xlsx';
                        content = `محتوى ملف Excel: ${file.title}\n\nالتصنيف: ${file.category}\nالتاريخ: ${file.date}\n${file.note ? `ملاحظات: ${file.note}\n` : ''}`;
                        break;
                    default:
                        content = `محتوى الملف: ${file.title}\n\nالتصنيف: ${file.category}\nالتاريخ: ${file.date}\n${file.note ? `ملاحظات: ${file.note}\n` : ''}\n\nهذا ملف تم إنشاؤه تلقائياً من نظام إدارة المدرسة.`;
                }
            } else {
                content = `محتوى الملف: ${file.title}\n\nالتصنيف: ${file.category}\nالتاريخ: ${file.date}\n${file.note ? `ملاحظات: ${file.note}\n` : ''}\n\nهذا محتوى نصي تم إرساله من إدارة المدرسة.`;
            }
            
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            link.href = url;
            link.download = file.file_name || `${file.title}.${extension}`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            // إغلاق نافذة المعاينة بعد التحميل
            closeFileViewer();
        }

        // مشاهدة الملف
        async function viewFile(fileId) {
            try {
                const currentStaff = JSON.parse(localStorage.getItem("currentStaff"));
                const currentTime = new Date().toISOString();
                const files = await Database.getFiles();
                const file = files.find(f => f.id === fileId);
                
                if (!file) {
                    alert("الملف غير موجود");
                    return;
                }

                // إضافة الملف إلى قائمة الملفات التي تم الاطلاع عليها
                if (!viewedFiles.includes(fileId)) {
                    viewedFiles.push(fileId);
                    localStorage.setItem("viewedFiles", JSON.stringify(viewedFiles));
                }
                
                // تسجيل حالة الاطلاع في قاعدة البيانات
                await Database.updateFileReadStatus(fileId, currentStaff.id, {
                    read: true,
                    read_date: currentTime,
                    staff_name: currentStaff.name
                });
                
                // تحديث الشريط الجانبي
                await loadCategoriesNav();
                
                // فتح محتوى الملف
                openFileContent(file);
                
            } catch (error) {
                console.error("خطأ في مشاهدة الملف:", error);
            }
        }

        // باقي الدوال تبقى كما هي بدون تغيير
        // [يتبع باقي الكود السابق بدون تغيير...]
