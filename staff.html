<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منسوبي المدرسة - مدرسة عمرو بن العاص</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
    <style>
        /* الاحتفاظ بكل التنسيقات كما كانت (لم يطرأ تغيير بصري كبير) */
        :root { --primary: #2c5aa0; --gray-light:#e9ecef; --border-radius:8px; --shadow:0 2px 10px rgba(0,0,0,0.1); --shadow-lg:0 5px 15px rgba(0,0,0,0.1); --transition:all .3s ease; --accent:#ff9800; --secondary:#4caf50; --primary-dark:#1e3d72; }
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;background:#f5f7fa;color:#343a40;direction:rtl}
        .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center}
        .modal.active{display:flex}
        .modal-content{background:#fff;border-radius:var(--border-radius);padding:20px;width:92%;max-width:900px;box-shadow:var(--shadow-lg);max-height:92vh;overflow:auto}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;border-bottom:1px solid var(--gray-light);padding-bottom:10px}
        .modal-body{display:flex;gap:15px;flex-direction:column}
        .new-file-list{max-height:320px;overflow:auto;padding:8px;border:1px solid var(--gray-light);border-radius:6px}
        .new-file-item{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid #f0f0f0}
        .preview-area{border:1px solid var(--gray-light);border-radius:6px;padding:8px;min-height:200px;display:flex;align-items:center;justify-content:center}
        .hidden{display:none}
        .btn{display:inline-flex;align-items:center;justify-content:center;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;gap:8px}
        .btn-primary{background:var(--primary);color:#fff}
        .btn-outline{background:transparent;border:1px solid #ccc}
        .badge{background:var(--accent);color:#fff;padding:2px 6px;border-radius:4px;font-size:12px;margin-left:8px}
        /* بقية التنسيقات تبقى كما كانت في ملفك الأصلي */
        /* ... (تم اختصار بقية CSS غير المتعلق بالنافذة لتقليل الحجم هنا) ... */
    </style>
</head>
<body>
    <!-- نافذة الاطلاع على الملفات الجديدة (مُحسّنة) -->
    <div id="newFilesModal" class="modal" aria-hidden="true">
        <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="newFilesTitle">
            <div class="modal-header">
                <h3 id="newFilesTitle">الملفات الجديدة المرسلة لك</h3>
                <button class="btn btn-outline" id="closeNewFilesBtn" title="إغلاق" onclick="tryCloseNewFilesModal()">×</button>
            </div>

            <div class="modal-body">
                <p id="newFilesIntro">يوجد لديك ملفات جديدة تحتاج إلى الاطلاع عليها. يرجى معاينتها جميعًا لإغلاق هذه النافذة.</p>

                <div class="new-file-list" id="newFilesList">
                    <!-- عناصر الملفات ستُضاف هنا -->
                </div>

                <div class="preview-area hidden" id="previewArea">
                    <!-- سيُعرض الملف هنا: iframe/img/object -->
                    <div id="previewContainer" style="width:100%;height:100%;min-height:280px;display:flex;align-items:center;justify-content:center"></div>
                </div>

                <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
                    <button class="btn btn-outline" onclick="openAllPublic()">فتح كل الملفات في تبويبات جديدة</button>
                    <button id="ackAllBtn" class="btn btn-primary" onclick="acknowledgeNewFiles()" disabled>
                        <i class="fas fa-check"></i> تمت معاينة الكل
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- -------- بقية الصفحة تبقى كما في ملفك الأصلي لكن تم اختصارها هنا للتركيز على التعديل -------- -->
    <!-- يمكنك لصق بقية staff.html الأصلية بعد هذه العلامة؛ لكن إذا تفضل أبقيت ملف كامل هنا ضمن التعديل -->
    <div class="staff-layout">
        <!-- الشريط الجانبي والتخطيط كما كان -->
        <!-- ... كامل المحتوى كما في staff.html الأصلي ... -->
    </div>

    <script>
        // --------- بيانات وحالة معاينات الملفات -----------
        let newFiles = [];
        let viewedFiles = JSON.parse(localStorage.getItem("viewedFiles")) || [];
        let previewedInModal = {}; // fileId -> true/false

        // محاولة تحميل ملفات المستخدِم كما في ملفك الأصلي
        async function loadUserFiles() {
            try {
                const files = await Database.getFiles();
                const currentStaff = JSON.parse(localStorage.getItem("currentStaff"));
                if (!currentStaff) return [];

                const userFiles = files.filter(file => {
                    if (file.target_staff && file.target_staff.includes(currentStaff.id)) return true;
                    if (currentStaff.jobs && currentStaff.jobs.includes("معلم") &&
                        file.target_subjects && file.target_subjects.some(subject =>
                            currentStaff.subjects && currentStaff.subjects.includes(subject)
                        )) return true;
                    if (currentStaff.jobs && currentStaff.jobs.includes("معلم") &&
                        file.target_classes && file.target_classes.some(cls =>
                            currentStaff.classes && currentStaff.classes.includes(cls)
                        )) return true;
                    return false;
                });

                return userFiles;
            } catch (err) {
                console.error("loadUserFiles error:", err);
                return [];
            }
        }

        // نتحقق من الملفات الجديدة ثم نعرض النافذة الموحدة
        async function checkNewFiles() {
            try {
                const userFiles = await loadUserFiles();
                const unseen = userFiles.filter(f => !viewedFiles.includes(f.id));
                newFiles = unseen;
                // تهيئة حالة المعاينة لكل ملف جديد
                previewedInModal = {};
                newFiles.forEach(f => previewedInModal[f.id] = false);

                if (newFiles.length > 0) {
                    renderNewFilesModal();
                    showNewFilesModal();
                } else {
                    // لا ملفات جديدة => تهيئة الواجهة العادية
                    await initializeStaffInterface();
                }
            } catch (err) {
                console.error("checkNewFiles error:", err);
            }
        }

        // بناء قائمة الملفات داخل النافذة الموحدة
        function renderNewFilesModal() {
            const list = document.getElementById("newFilesList");
            list.innerHTML = '';

            newFiles.forEach(file => {
                const isViewed = viewedFiles.includes(file.id);
                const item = document.createElement('div');
                item.className = 'new-file-item';
                item.innerHTML = `
                    <div style="flex:1; margin-left:10px">
                        <strong>${file.title || file.file_name || 'بدون عنوان'}</strong>
                        ${file.note ? `<div style="font-size:12px;color:#666;margin-top:4px">${file.note}</div>` : ''}
                        <div style="font-size:12px;color:#666;margin-top:6px">${file.category || ''} · ${file.date || ''}</div>
                    </div>
                    <div style="display:flex;gap:6px;align-items:center">
                        <button class="btn btn-outline btn-sm" onclick="previewFileInModal('${file.id}')">
                            <i class="fas fa-eye"></i> معاينة
                        </button>
                        <button class="btn btn-outline btn-sm" onclick="downloadFile('${file.id}')">
                            <i class="fas fa-download"></i> تحميل
                        </button>
                        ${isViewed ? `<span class="badge">مطّلع سابقًا</span>` : ''}
                    </div>
                `;
                list.appendChild(item);
            });

            // إظهار حالة الزر
            updateAckButtonState();
        }

        function showNewFilesModal() {
            document.getElementById("newFilesModal").classList.add("active");
            document.getElementById("newFilesModal").ariaHidden = "false";
            // منع الإغلاق بالضغط على خلفية النافذة — إلا إذا عُرضت كل الملفات
            document.getElementById("newFilesModal").addEventListener('click', function(e){
                if (e.target === this) {
                    tryCloseNewFilesModal();
                }
            });
        }

        // محاولة إغلاق النافذة: ستغلق فقط لو جميع الملفات مُعاينة
        function tryCloseNewFilesModal() {
            const allPreviewed = newFiles.every(f => previewedInModal[f.id] === true);
            if (allPreviewed) {
                closeNewFilesModal();
            } else {
                alert("الرجاء معاينة جميع الملفات قبل إغلاق هذه النافذة.");
            }
        }

        function closeNewFilesModal() {
            document.getElementById("newFilesModal").classList.remove("active");
            document.getElementById("newFilesModal").ariaHidden = "true";
            document.getElementById("previewArea").classList.add("hidden");
            document.getElementById("previewContainer").innerHTML = '';
            // بعد الإغلاق، تأكد من تحديث الواجهة الرئيسية
            initializeStaffInterface();
        }

        function updateAckButtonState() {
            const ackBtn = document.getElementById("ackAllBtn");
            const allPreviewed = newFiles.length === 0 ? true : newFiles.every(f => previewedInModal[f.id] === true);
            ackBtn.disabled = !allPreviewed;
        }

        // معاينة ملف داخل النافذة: تحاول الحصول على public URL أو تنزيل وعرضه
        async function previewFileInModal(fileId) {
            try {
                const file = newFiles.find(f => f.id === fileId) || (await Database.getFiles()).find(ff => ff.id === fileId);
                if (!file) { alert("تعذر العثور على الملف."); return; }

                // جلب رابط عام إن أمكن
                const publicUrl = await Database.getFilePublicUrl(file);

                // إظهار مساحت المعاينة
                const previewArea = document.getElementById("previewArea");
                const previewContainer = document.getElementById("previewContainer");
                previewContainer.innerHTML = ''; // تفريغ
                previewArea.classList.remove("hidden");

                // الاستراتيجية: إذا حصلنا على publicUrl نستخدمه داخل iframe/img/object
                // وإلا نححاول تنزيل blob وعرضه مؤقتًا كرابط Object URL
                let urlToUse = null;
                if (publicUrl) {
                    urlToUse = publicUrl;
                } else {
                    // جرب تنزيل blob من التخزين (قد يفشل إذا الملف خاص)
                    const downloadResult = await Database.downloadFileFromStorage(file);
                    if (downloadResult && downloadResult.success) {
                        // إذا نجح التنزيل، فتح نافذة جديدة أو السماح للمتصفح بفتح الملف
                        // لأن downloadFileFromStorage يقوم بالتحميل مباشرة، نعطي ملاحظة للمستخدم
                        previewContainer.innerHTML = `<div style="padding:12px;color:#333">تم تنزيل الملف لعرضه (يفتح التنزيل في نافذة المتصفح/التنزيل).</div>`;
                        // علم أن الملف قد تم "معاينته"
                        markFilePreviewed(fileId, file);
                        return;
                    } else {
                        // لا يمكن تنزيل الملف؛ حاول بناء رابط من ف.file_name (قد لا يعمل)
                        urlToUse = null;
                    }
                }

                if (urlToUse) {
                    // اختيار طريقة العرض حسب امتداد الملف
                    const lower = urlToUse.toLowerCase();
                    if (lower.endsWith('.pdf')) {
                        previewContainer.innerHTML = `<iframe src="${urlToUse}" style="width:100%;height:520px;border:0"></iframe>`;
                    } else if (lower.match(/\.(jpg|jpeg|png|gif|bmp|webp)$/)) {
                        previewContainer.innerHTML = `<img src="${urlToUse}" alt="preview" style="max-width:100%;max-height:520px;border-radius:6px" />`;
                    } else {
                        // عرض داخل iframe كخيار عام (قد يعرض Office/Google preview إن مدعوم)
                        previewContainer.innerHTML = `<iframe src="${urlToUse}" style="width:100%;height:520px;border:0"></iframe>`;
                    }

                    // علم أن الملف قد عُرض (معاينة)
                    markFilePreviewed(fileId, file);
                } else {
                    alert("تعذر الحصول على معاينة لهذا الملف (قد يكون الملف خاصاً). يمكنك المحاولة بالتحميل.");
                }
            } catch (err) {
                console.error("previewFileInModal error:", err);
                alert("حدث خطأ أثناء محاولة المعاينة.");
            }
        }

        // بعد المعاينة: علمه كمطّلع وسجّله في قاعدة البيانات
        async function markFilePreviewed(fileId, fileRecord) {
            try {
                previewedInModal[fileId] = true;
                // أضفه إلى viewedFiles المحلي إن لم يكن موجودًا
                if (!viewedFiles.includes(fileId)) {
                    viewedFiles.push(fileId);
                    localStorage.setItem("viewedFiles", JSON.stringify(viewedFiles));
                }

                // سجّل القراءة في قاعدة البيانات (إذا كان currentStaff موجودًا)
                const currentStaff = JSON.parse(localStorage.getItem("currentStaff"));
                if (currentStaff) {
                    const currentTime = new Date().toISOString();
                    await Database.updateFileReadStatus(fileId, currentStaff.id, {
                        read: true,
                        read_date: currentTime,
                        staff_name: currentStaff.name
                    });
                }

                // حدّث واجهة الشريط الجانبي
                await loadCategoriesNav?.();

                // حدّث زر التأكيد/الإغلاق
                updateAckButtonState();

                // إذا كانت كل الملفات معاينة، اغلق النافذة تلقائياً بعد ثانية
                const allPreviewed = newFiles.every(f => previewedInModal[f.id] === true);
                if (allPreviewed) {
                    setTimeout(() => {
                        closeNewFilesModal();
                    }, 900); // تأخير صغير للمستخدم ليرى أن كل شيء اكتمل
                }
            } catch (err) {
                console.error("markFilePreviewed error:", err);
            }
        }

        // تنزيل الملف (يستخدم Database.downloadFileFromStorage)
        async function downloadFile(fileId) {
            try {
                // ابحث عن السجل
                let file = newFiles.find(f => f.id === fileId);
                if (!file) {
                    const filesAll = await Database.getFiles();
                    file = filesAll.find(f => f.id === fileId);
                }
                if (!file) { alert("تعذر العثور على الملف."); return; }

                // علامة مشاهدة/تنزيل
                const currentStaff = JSON.parse(localStorage.getItem("currentStaff"));
                const currentTime = new Date().toISOString();
                if (!viewedFiles.includes(fileId)) {
                    viewedFiles.push(fileId);
                    localStorage.setItem("viewedFiles", JSON.stringify(viewedFiles));
                }
                if (currentStaff) {
                    await Database.updateFileReadStatus(fileId, currentStaff.id, {
                        read: true,
                        read_date: currentTime,
                        staff_name: currentStaff.name,
                        downloaded: true
                    });
                }
                await loadCategoriesNav?.();

                // قم بالتنزيل الفعلي
                const res = await Database.downloadFileFromStorage(file);
                if (!res.success) {
                    alert("حدث خطأ أثناء محاولة تنزيل الملف. إذا كان الملف خاصًا قد يتطلب صلاحيات خاصة.");
                }
            } catch (err) {
                console.error("downloadFile error:", err);
                alert("حدث خطأ أثناء التحميل.");
            }
        }

        // فتح جميع الملفات في تبويبات جديدة (public URLs إن توافرت)
        async function openAllPublic() {
            for (const file of newFiles) {
                const pub = await Database.getFilePublicUrl(file);
                if (pub) {
                    window.open(pub, '_blank');
                    // علم كمعاين (لأن المستخدم فتحه)
                    previewedInModal[file.id] = true;
                    if (!viewedFiles.includes(file.id)) {
                        viewedFiles.push(file.id);
                    }
                    const currentStaff = JSON.parse(localStorage.getItem("currentStaff"));
                    if (currentStaff) {
                        await Database.updateFileReadStatus(file.id, currentStaff.id, {
                            read: true,
                            read_date: new Date().toISOString(),
                            staff_name: currentStaff.name
                        });
                    }
                } else {
                    // إذا لا يوجد public URL حاول تنزيله
                    await Database.downloadFileFromStorage(file);
                }
            }
            localStorage.setItem("viewedFiles", JSON.stringify(viewedFiles));
            updateAckButtonState();
            // اغلق تلقائياً إن كانت كل الملفات الآن معاينة
            const allPreviewed = newFiles.every(f => previewedInModal[f.id] === true);
            if (allPreviewed) closeNewFilesModal();
        }

        // زر التأكيد في النافذة: يؤدي نفس وظيفة الإغلاق (إن كانت جميع المعاينات تمت)
        async function acknowledgeNewFiles() {
            const allPreviewed = newFiles.every(f => previewedInModal[f.id] === true);
            if (!allPreviewed) {
                alert("الرجاء معاينة جميع الملفات قبل التأكيد.");
                return;
            }

            const currentStaff = JSON.parse(localStorage.getItem("currentStaff"));
            const currentTime = new Date().toISOString();
            for (const file of newFiles) {
                if (!viewedFiles.includes(file.id)) {
                    viewedFiles.push(file.id);
                }
                if (currentStaff) {
                    await Database.updateFileReadStatus(file.id, currentStaff.id, {
                        read: true,
                        read_date: currentTime,
                        staff_name: currentStaff.name
                    });
                }
            }
            localStorage.setItem("viewedFiles", JSON.stringify(viewedFiles));
            closeNewFilesModal();
        }

        // ------------------ باقي دوال الصفحة (كما في ملفك الأصلي) ------------------
        // ضع هنا بقية دوال loadCategoriesNav, loadFiles, loadEvents, loadTeacherSchedule, loadTeachersSchedule, loadWorkScheduleInfo, showSection, showCategory, filterFilesByCategory, printSchedule, printTeachersSchedule, displayUserName, logout, initializeStaffInterface وغيرها
        // لتحسين السرعة قمت بالإبقاء على نفس أسماء الدوال كما في ملفك الأصلي كي لا يؤثر التعديل على باقي الواجهة.
        // مثال: في ملف staff.html الأصلي لديك دوال جاهزة. تأكد من إدراجها أسفل هذا الكود كما كانت.
        // ----------------------------------------------------------------------------

        // تحميل حالة الاطلاع وأبداية التنفيذ
        document.addEventListener("DOMContentLoaded", async function() {
            if (localStorage.getItem("role") !== "staff") {
                // إذا لم يكن الموظف مسجلًا أعد التوجيه
                // window.location.href = "index.html";
                // لكن أثناء الاختبار يمكنك تعليق السطر أعلاه
            }

            try {
                // تحميل حالة الاطلاع من قاعدة البيانات (إن أردت استخدامها)
                // fileReadStatus = await Database.getFileReadStatus();
            } catch (err) {
                console.error("error loading read status:", err);
            }

            // عرض اسم المستخدم (إن وجد)
            displayUserName?.();

            // تحقق من وجود ملفات جديدة
            await checkNewFiles();
        });

    </script>
</body>
</html>
